

name: Unified CI

on: [push, pull_request]

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12"]
        exclude:
          - os: windows-latest
            python-version: "3.11"
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: ${{ matrix.os == 'ubuntu-latest' && 'pip' || '' }}

      - name: Install Vulkan (Windows only)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/xinntao/real-esrgan-ncnn-vulkan/releases/download/20220424-windows/real-esrgan-ncnn-vulkan-20220424-windows.zip" -OutFile vulkan.zip
          Expand-Archive vulkan.zip -DestinationPath .

      - run: pip install -e '.[dev]'

      - name: Run tests
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            pytest tests/test_ncnn_backend.py -v
          else
            pytest --cov=scaleforge
          fi

      - name: Upload coverage (Linux only)
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4

  e2e-test-upscale:
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: |
          pip install -e .
          pip install pillow
          mkdir -p assets output
          chmod +x scripts/test-upscale.sh
          ./scripts/test-upscale.sh
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: upscale-results
          path: output/

